{% extends 'main/base.html' %}
{% load static %}
{% load post_tags %}
{% load i18n %}

{% block title %}{{ profile.nickname }}{% endblock %}
{% block page_header %}{{ profile.nickname }}{% endblock %}

{% block content %}
<div class="modern-profile-container">
    <!-- Profil Header -->
    <div class="profile-header">
        <div class="profile-cover">
            <div class="profile-info">
                <div class="profile-avatar">
                    <div class="avatar-circle">
                        <i class="bi bi-person-fill"></i>
                    </div>
                </div>
                <div class="profile-details">
                    <h2 class="profile-name">{{ profile.nickname }}</h2>
                    <p class="profile-username">@{{ profile.username }}</p>
                    {% if profile.biography %}
                        <p class="profile-bio">{{ profile.biography|render_emojis }}</p>
                    {% endif %}
                    <div class="profile-meta">
                        <span class="meta-item">
                            <i class="bi bi-file-post"></i>
                            {{ entries.count }} entry
                        </span>
                        <span class="meta-item">
                            <i class="bi bi-people"></i>
                            {{ follower_count }} takipçi
                        </span>
                        <span class="meta-item">
                            <i class="bi bi-person-plus"></i>
                            {{ following_count }} takip
                        </span>
                    </div>
                    {% if profile.instagram_username or profile.twitter_username or profile.youtube_url or profile.tiktok_username or profile.linkedin_url or profile.github_username or profile.website_url or profile.facebook_username %}
                        <div class="social-links">
                            {% if profile.website_url %}
                                <a href="{{ profile.website_url }}" target="_blank" class="social-link website" title="{% trans 'Website' %}">
                                    <i class="bi bi-globe"></i>
                                </a>
                            {% endif %}
                            {% if profile.instagram_username %}
                                <a href="https://instagram.com/{{ profile.instagram_username }}" target="_blank" class="social-link instagram" title="Instagram">
                                    <i class="bi bi-instagram"></i>
                                </a>
                            {% endif %}
                            {% if profile.twitter_username %}
                                <a href="https://twitter.com/{{ profile.twitter_username }}" target="_blank" class="social-link twitter" title="Twitter">
                                    <i class="bi bi-twitter"></i>
                                </a>
                            {% endif %}
                            {% if profile.facebook_username %}
                                <a href="https://facebook.com/{{ profile.facebook_username }}" target="_blank" class="social-link facebook" title="Facebook">
                                    <i class="bi bi-facebook"></i>
                                </a>
                            {% endif %}
                            {% if profile.youtube_url %}
                                <a href="{{ profile.youtube_url }}" target="_blank" class="social-link youtube" title="YouTube">
                                    <i class="bi bi-youtube"></i>
                                </a>
                            {% endif %}
                            {% if profile.tiktok_username %}
                                <a href="https://tiktok.com/@{{ profile.tiktok_username }}" target="_blank" class="social-link tiktok" title="TikTok">
                                    <i class="bi bi-tiktok"></i>
                                </a>
                            {% endif %}
                            {% if profile.linkedin_url %}
                                <a href="{{ profile.linkedin_url }}" target="_blank" class="social-link linkedin" title="LinkedIn">
                                    <i class="bi bi-linkedin"></i>
                                </a>
                            {% endif %}
                            {% if profile.github_username %}
                                <a href="https://github.com/{{ profile.github_username }}" target="_blank" class="social-link github" title="GitHub">
                                    <i class="bi bi-github"></i>
                                </a>
                            {% endif %}
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Action Buttons -->
        <div class="profile-actions">
            {% if user.is_authenticated and user != profile.user %}
                <button class="action-btn primary follow-btn" data-username="{{ profile.username }}">
                    <i class="bi bi-person-plus"></i>
                    <span>{% if is_following %}{% trans "Takibi Bırak" %}{% else %}{% trans "Takip Et" %}{% endif %}</span>
                </button>
            {% endif %}
        </div>
    </div>

    <!-- Modern Tabs -->
    <div class="profile-tabs">
        <div class="tabs-container">
            <a class="tab-item {% if not tab or tab == 'entries' %}active{% endif %}" href="{% url 'profile_detail' profile.username %}?tab=entries">
                <i class="bi bi-chat-text"></i>
                <span>{% trans "Entry'ler" %}</span>
            </a>
            <a class="tab-item {% if tab == 'topics' %}active{% endif %}" href="{% url 'profile_detail' profile.username %}?tab=topics">
                <i class="bi bi-chat-square-text"></i>
                <span>{% trans "Başlıklar" %}</span>
            </a>
        </div>
    </div>

    <!-- Content Area -->
    <div class="profile-content">
        {% if tab == 'topics' %}
        <!-- Topic'ler -->
        <div class="content-section">
            {% for topic in topics %}
                <div class="content-card">
                    <div class="card-header">
                        <div class="card-info">
                            <a href="{% url 'topic_detail' topic.slug %}" class="card-title">
                                {{ topic.title }}
                            </a>
                            <div class="card-meta">
                                <span class="meta-item">
                                    <i class="bi bi-chat"></i>
                                    {{ topic.entry_count }} entry
                                </span>
                                <span class="meta-item">
                                    <i class="bi bi-clock"></i>
                                    {{ topic.created_at|date:"d.m.Y" }}
                                </span>
                            </div>
                        </div>
                    </div>
                    <div class="card-footer">
                        <div class="vote-actions">
                            <button class="vote-btn up {% if user in topic.upvotes.all %}active{% endif %}" data-topic-slug="{{ topic.slug }}" data-vote-type="up">
                                <i class="bi bi-arrow-up"></i>
                            </button>
                            <span class="vote-count">{{ topic.vote_score }}</span>
                            <button class="vote-btn down {% if user in topic.downvotes.all %}active{% endif %}" data-topic-slug="{{ topic.slug }}" data-vote-type="down">
                                <i class="bi bi-arrow-down"></i>
                            </button>
                        </div>
                    </div>
                </div>
            {% empty %}
                <div class="empty-state">
                    <i class="bi bi-chat-square-text"></i>
                    <p>{% trans "Henüz başlık açmamış." %}</p>
                </div>
            {% endfor %}
        </div>
        
        
        {% else %}
        <!-- Entry'ler -->
        <div class="content-section">
            {% for entry in entries %}
                <div class="content-card entry-card">
                    <div class="card-header">
                        <div class="card-info">
                            <a href="{% url 'topic_detail' entry.topic.slug %}" class="topic-link">
                                {{ entry.topic.title }}
                            </a>
                            <div class="card-meta">
                                <span class="meta-item">
                                    <i class="bi bi-clock"></i>
                                    {{ entry.created_at|date:"d.m.Y H:i" }}
                                </span>
                            </div>
                        </div>
                    </div>
                    <div class="entry-content">
                        <a href="{% url 'topic_detail' entry.topic.slug %}#entry-{{ entry.id }}" class="entry-text">
                            {{ entry.content|render_emojis|with_entry_font:entry|linebreaks }}
                        </a>
                    </div>
                    <div class="card-footer">
                        <div class="vote-actions">
                            <button class="vote-btn up {% if user in entry.upvotes.all %}active{% endif %}" data-entry-id="{{ entry.id }}" data-vote-type="up">
                                <i class="bi bi-arrow-up"></i>
                            </button>
                            <span class="vote-count">{{ entry.vote_score }}</span>
                            <button class="vote-btn down {% if user in entry.downvotes.all %}active{% endif %}" data-entry-id="{{ entry.id }}" data-vote-type="down">
                                <i class="bi bi-arrow-down"></i>
                            </button>
                        </div>
                    </div>
                </div>
            {% empty %}
                <div class="empty-state">
                    <i class="bi bi-chat-text"></i>
                    <p>{% trans "Henüz entry yazmamış." %}</p>
                </div>
            {% endfor %}
        </div>
        {% endif %}
    </div>
</div>

<script>
// CSRF token alma fonksiyonu
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

document.addEventListener('DOMContentLoaded', function() {
    // Takip etme fonksiyonu
    const followBtn = document.getElementById('followBtn');
    if (followBtn) {
        followBtn.addEventListener('click', function() {
            const username = this.dataset.username;
            
            fetch(`/toggle-follow/${username}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
            })
            .then(response => response.json())
            .then(data => {
                const span = this.querySelector('span');
                if (data.is_following) {
                    span.textContent = '{% trans "Takibi Bırak" %}';
                } else {
                    span.textContent = '{% trans "Takip Et" %}';
                }
            })
            .catch(error => console.error('Error:', error));
        });
    }
    
    // Bookmark tab switching
    document.querySelectorAll('.bookmark-tab').forEach(btn => {
        btn.addEventListener('click', function() {
            const tabName = this.dataset.bookmarkTab;
            
            // Update button states
            document.querySelectorAll('.bookmark-tab').forEach(b => {
                b.classList.remove('active');
            });
            this.classList.add('active');
            
            // Show/hide content
            document.querySelectorAll('.bookmark-content').forEach(content => {
                content.classList.add('d-none');
            });
            const targetContent = document.getElementById('bookmark-' + tabName);
            if (targetContent) {
                targetContent.classList.remove('d-none');
            }
        });
    });
});
</script>
{% endblock %}

{% block extra_css %}
    <link href="{% static 'main/css/profile.css' %}" rel="stylesheet">
    <link href="{% static 'main/css/modern-profile.css' %}" rel="stylesheet">
{% endblock %}

{% block extra_scripts %}
<script src="{% static 'main/js/bookmarks.js' %}"></script>
{% endblock %}