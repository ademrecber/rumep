{% extends 'main/base.html' %}
{% load static %}
{% load post_tags %}
{% load i18n %}
{% block title %}{% trans "Gündem" %}{% endblock %}

{% block page_header %}{% trans "Gündem" %}{% endblock %}

{% block page_tabs %}
<div class="d-flex p-3" style="gap: 0;">
    <a href="?tab=topics" class="flex-fill text-center py-2 text-decoration-none {% if not active_tab or active_tab == 'topics' %}border-bottom border-primary text-primary fw-bold{% else %}text-muted{% endif %}" style="border-bottom: 2px solid transparent;">
        <i class="bi bi-fire me-1"></i>{% trans "Trend Başlıklar" %}
    </a>
    <a href="?tab=writers" class="flex-fill text-center py-2 text-decoration-none {% if active_tab == 'writers' %}border-bottom border-primary text-primary fw-bold{% else %}text-muted{% endif %}" style="border-bottom: 2px solid transparent;">
        <i class="bi bi-people me-1"></i>{% trans "Aktif Yazarlar" %}
    </a>
    <a href="?tab=categories" class="flex-fill text-center py-2 text-decoration-none {% if active_tab == 'categories' %}border-bottom border-primary text-primary fw-bold{% else %}text-muted{% endif %}" style="border-bottom: 2px solid transparent;">
        <i class="bi bi-tags me-1"></i>{% trans "Kategoriler" %}
    </a>
</div>
{% endblock %}

{% block content %}



<div class="popular-content">
        <!-- Gündem Başlıkları -->
        <div class="tab-content {% if active_tab != 'topics' %}d-none{% endif %}" id="topics-tab">
            <!-- Zaman Filtreleri -->
            <div class="period-tabs mb-4 text-center">
                <div class="btn-group btn-group-sm" role="group">
                    <a href="?tab=topics&period=today" class="btn {% if active_period == 'today' %}btn-primary{% else %}btn-outline-primary{% endif %}">Bugün</a>
                    <a href="?tab=topics&period=weekly" class="btn {% if active_period == 'weekly' %}btn-primary{% else %}btn-outline-primary{% endif %}">Bu Hafta</a>
                    <a href="?tab=topics&period=monthly" class="btn {% if active_period == 'monthly' %}btn-primary{% else %}btn-outline-primary{% endif %}">Bu Ay</a>
                    <a href="?tab=topics&period=all-time" class="btn {% if active_period == 'all-time' %}btn-primary{% else %}btn-outline-primary{% endif %}">Tüm Zamanlar</a>
                </div>
            </div>
            <div class="topic-container">
                {% for topic in trending_topics %}
                    {% with first_entry=topic.entries.first %}
                        <div class="topic-item mb-4">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <a href="{% url 'topic_detail' topic.slug %}" class="text-decoration-none text-dark">
                                        <h5 class="mb-1">{{ topic.title }}</h5>
                                    </a>
                                    
                                    {% if first_entry %}
                                    <div class="first-entry-preview text-muted mb-2" style="font-size: 0.85rem; color: #6c757d;">
                                        {% if first_entry.content|length > 790 %}
                                            {{ first_entry.content|slice:":790"|render_emojis|with_entry_font:first_entry }}
                                            <a href="{% url 'topic_detail' topic.slug %}" class="text-primary text-decoration-none">...{% trans "devamını gör" %}</a>
                                        {% else %}
                                            {{ first_entry.content|render_emojis|with_entry_font:first_entry }}
                                        {% endif %}
                                    </div>
                                    {% endif %}
                                    
                                    <small class="text-muted">
                                        {{ topic.daily_entry_count }} {% trans "entry" %} ({% trans "son 24 saat" %}) • 
                                        {{ topic.user.profile.nickname }} {% trans "tarafından açıldı" %} •
                                        {{ topic.created_at|date:"d.m.Y H:i" }}
                                    </small>
                                    

                                </div>
                                <div class="text-end">
                                    <span class="badge bg-primary">{{ topic.daily_entry_count }}</span>
                                </div>
                            </div>
                        </div>
                    {% endwith %}
                {% empty %}
                    <p class="text-muted p-3">{% trans "Henüz gündem başlığı yok." %}</p>
                {% endfor %}
            </div>
            
            <!-- Loading ve Load More -->
            <div id="loading" class="mt-3" style="display: none;">
                {% for i in "123" %}
                <div class="topic-item mb-4">
                    <div class="placeholder-glow">
                        <span class="placeholder col-8 mb-2"></span>
                        <span class="placeholder col-4 mb-3"></span>
                        <span class="placeholder col-12 mb-1"></span>
                        <span class="placeholder col-10 mb-1"></span>
                        <span class="placeholder col-6"></span>
                    </div>
                </div>
                {% endfor %}
            </div>
            <button id="load-more-btn" class="btn btn-primary mt-3" style="display: block;">{% trans "Daha Fazla Yükle" %}</button>
            <div id="error-message" class="text-danger mt-3" style="display: none;"></div>
        </div>
        
        <!-- Aktif Yazarlar -->
        <div class="tab-content {% if active_tab != 'writers' %}d-none{% endif %}" id="writers-tab">
            <div class="writers-container">
                {% for writer in active_writers %}
                <div class="writer-item mb-4 p-3 border rounded">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <div class="d-flex align-items-center mb-2">
                                <div class="rounded-circle bg-primary d-flex align-items-center justify-content-center me-3" style="width: 50px; height: 50px;">
                                    <i class="bi bi-person text-white fs-4"></i>
                                </div>
                                <div>
                                    <h6 class="mb-0">
                                        <a href="{% url 'profile_detail' writer.username %}" class="text-decoration-none text-dark">
                                            {{ writer.nickname }}
                                        </a>
                                        {% if writer.user_role != 'user' %}
                                            <span class="badge bg-warning text-dark ms-1">{{ writer.get_user_role_display }}</span>
                                        {% endif %}
                                    </h6>
                                    <small class="text-muted">@{{ writer.username }}</small>
                                </div>
                            </div>
                            {% if writer.biography %}
                                <p class="text-muted mb-2" style="font-size: 0.9rem;">{{ writer.biography|truncatechars:100 }}</p>
                            {% endif %}
                            <div class="stats d-flex gap-3">
                                <small class="text-muted">
                                    <i class="bi bi-chat-dots me-1"></i>{{ writer.topic_count|default:0 }} başlık
                                </small>
                                <small class="text-muted">
                                    <i class="bi bi-file-text me-1"></i>{{ writer.entry_count|default:0 }} entry
                                </small>
                                <small class="text-muted">
                                    <i class="bi bi-star me-1"></i>{{ writer.katki_puani }} puan
                                </small>
                            </div>
                        </div>
                        {% if user.is_authenticated and user != writer.user %}
                        <button class="btn btn-outline-primary btn-sm follow-btn" data-username="{{ writer.username }}">
                            <i class="bi bi-person-plus me-1"></i>{% trans "Takip Et" %}
                        </button>
                        {% endif %}
                    </div>
                </div>
                {% empty %}
                    <p class="text-muted p-3">{% trans "Henüz aktif yazar yok." %}</p>
                {% endfor %}
            </div>
        </div>
        
        <!-- Kategoriler -->
        <div class="tab-content {% if active_tab != 'categories' %}d-none{% endif %}" id="categories-tab">
            <div class="categories-container">
                {% for category in popular_categories %}
                    <div class="category-item mb-4">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-1">
                                    <a href="{% url 'category_detail' category.slug %}" class="text-decoration-none text-dark">
                                        #{{ category.name }}
                                    </a>
                                </h6>
                                {% if category.description %}
                                    <small class="text-muted">{{ category.description }}</small>
                                {% endif %}
                            </div>
                            <div class="text-end">
                                <span class="badge bg-primary">{{ category.topic_count }}</span>
                                <small class="text-muted d-block">{% trans "başlık" %}</small>
                            </div>
                        </div>
                    </div>
                {% empty %}
                    <p class="text-muted p-3">{% trans "Henüz kategori yok." %}</p>
                {% endfor %}
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_scripts %}
    <script type="module" src="{% static 'main/js/load-more.js' %}"></script>
    <script>
        // Popular sayfa için Load More fonksiyonları
        window.offset = 20; // İlk 20 yüklendi
        window.hasMore = true;
        window.loading = false;
        
        function getCsrfToken() {
            return document.querySelector('[name=csrfmiddlewaretoken]')?.value || document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
        }
        
        async function loadMorePopular() {
            if (window.loading || !window.hasMore) return;
            
            window.loading = true;
            const loadingDiv = document.getElementById('loading');
            const loadMoreBtn = document.getElementById('load-more-btn');
            const errorMessage = document.getElementById('error-message');
            
            if (loadingDiv) loadingDiv.style.display = 'block';
            if (loadMoreBtn) loadMoreBtn.style.display = 'none';
            if (errorMessage) errorMessage.style.display = 'none';
            
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const period = urlParams.get('period') || 'today';
                const url = `/load-more-popular/?offset=${window.offset}&period=${period}`;
                
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-CSRFToken': getCsrfToken()
                    }
                });
                
                if (!response.ok) throw new Error(`Ağ hatası: ${response.status}`);
                
                const data = await response.json();
                
                if (data.posts && Array.isArray(data.posts)) {
                    const fragment = document.createDocumentFragment();
                    data.posts.forEach(topic => {
                        const topicDiv = document.createElement('div');
                        topicDiv.className = 'topic-item mb-4';
                        topicDiv.innerHTML = `
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <a href="/topic/${topic.short_id}/" class="text-decoration-none text-dark">
                                        <h5 class="mb-1">${topic.title}</h5>
                                    </a>
                                    
                                    ${topic.text ? `
                                    <div class="first-entry-preview text-muted mb-2" style="font-size: 0.85rem; color: #6c757d;">
                                        ${topic.text.length > 790 ? 
                                            topic.text.substring(0, 790) + '<a href="/topic/' + topic.short_id + '/" class="text-primary text-decoration-none">...devamını gör</a>' : 
                                            topic.text
                                        }
                                    </div>
                                    ` : ''}
                                    
                                    <small class="text-muted">
                                        ${topic.daily_entry_count || topic.comment_count} entry • 
                                        ${topic.nickname} tarafından açıldı •
                                        ${new Date(topic.created_at).toLocaleDateString('tr-TR')} ${new Date(topic.created_at).toLocaleTimeString('tr-TR', {hour: '2-digit', minute: '2-digit'})}
                                    </small>
                                </div>
                                <div class="text-end">
                                    <span class="badge bg-primary">${topic.daily_entry_count || topic.comment_count}</span>
                                </div>
                            </div>
                        `;
                        fragment.appendChild(topicDiv);
                    });
                    
                    const topicContainer = document.querySelector('.topic-container');
                    if (topicContainer) {
                        topicContainer.appendChild(fragment);
                    }
                    
                    window.offset += 10;
                    window.hasMore = data.has_more;
                }
                
                if (loadMoreBtn) {
                    loadMoreBtn.style.display = window.hasMore ? 'block' : 'none';
                }
            } catch (error) {
                console.error('Hata:', error);
                if (errorMessage) {
                    errorMessage.textContent = `Yükleme hatası: ${error.message}`;
                    errorMessage.style.display = 'block';
                }
                if (loadMoreBtn) loadMoreBtn.style.display = 'block';
            } finally {
                window.loading = false;
                if (loadingDiv) loadingDiv.style.display = 'none';
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            // Load More butonu
            const loadMoreBtn = document.getElementById('load-more-btn');
            if (loadMoreBtn) {
                loadMoreBtn.addEventListener('click', loadMorePopular);
            }
            
            // Show more/less functionality
            document.querySelectorAll('.show-more-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const card = this.closest('.entry-card');
                    const preview = card.querySelector('.text-preview');
                    const fullText = card.querySelector('.full-text');
                    
                    if (preview) preview.classList.add('d-none');
                    if (fullText) fullText.classList.remove('d-none');
                    this.classList.add('d-none');
                });
            });
            
            // Topic vote functionality
            document.querySelectorAll('.vote-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const topicSlug = this.dataset.topicSlug;
                    const voteType = this.dataset.voteType;
                    
                    fetch(`/topic/${topicSlug}/vote/`, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: `vote_type=${voteType}`
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.vote_score !== undefined) {
                            const card = this.closest('.topic-item');
                            const scoreElement = card.querySelector('.vote-score');
                            const upBtn = card.querySelector('[data-vote-type="up"]');
                            const downBtn = card.querySelector('[data-vote-type="down"]');
                            
                            scoreElement.textContent = data.vote_score;
                            
                            if (voteType === 'up') {
                                const icon = upBtn.querySelector('i');
                                if (data.voted) {
                                    icon.className = 'bi bi-arrow-up-circle-fill text-success';
                                } else {
                                    icon.className = 'bi bi-arrow-up';
                                }
                                downBtn.querySelector('i').className = 'bi bi-arrow-down';
                            } else {
                                const icon = downBtn.querySelector('i');
                                if (data.voted) {
                                    icon.className = 'bi bi-arrow-down-circle-fill text-danger';
                                } else {
                                    icon.className = 'bi bi-arrow-down';
                                }
                                upBtn.querySelector('i').className = 'bi bi-arrow-up';
                            }
                        }
                    })
                    .catch(error => console.error('Error:', error));
                });
            });
            
            // Entry vote functionality
            document.querySelectorAll('.entry-vote-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const entryId = this.dataset.entryId;
                    const voteType = this.dataset.voteType;
                    
                    fetch(`/entry/${entryId}/vote/`, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: `vote_type=${voteType}`
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.vote_score !== undefined) {
                            const entryCard = this.closest('.entry-item');
                            const scoreElement = entryCard.querySelector('.entry-vote-score');
                            const upBtn = entryCard.querySelector('[data-vote-type="up"]');
                            const downBtn = entryCard.querySelector('[data-vote-type="down"]');
                            
                            scoreElement.textContent = data.vote_score;
                            
                            if (voteType === 'up') {
                                const icon = upBtn.querySelector('i');
                                if (data.voted) {
                                    icon.className = 'bi bi-arrow-up-circle-fill text-success';
                                } else {
                                    icon.className = 'bi bi-arrow-up';
                                }
                                downBtn.querySelector('i').className = 'bi bi-arrow-down';
                            } else {
                                const icon = downBtn.querySelector('i');
                                if (data.voted) {
                                    icon.className = 'bi bi-arrow-down-circle-fill text-danger';
                                } else {
                                    icon.className = 'bi bi-arrow-down';
                                }
                                upBtn.querySelector('i').className = 'bi bi-arrow-up';
                            }
                        }
                    })
                    .catch(error => console.error('Error:', error));
                });
            });
        });
    </script>
{% endblock %}