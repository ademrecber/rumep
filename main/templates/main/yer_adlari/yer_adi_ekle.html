{% extends 'main/base.html' %}
{% load static %}

{% block content %}
<div class="container mt-4">
    <h1>{% if is_edit %}Yer Adı Düzenle{% else %}Yer Adı Ekle{% endif %}</h1>
    
    <!-- Google Maps Haritası -->
    <div id="map" style="height: 400px; margin-bottom: 20px;"></div>
    
    <form method="post" id="yer-adi-form">
        {% csrf_token %}
        <div class="mb-3">
            <label for="{{ form.ad.id_for_label }}" class="form-label">Yer Adı</label>
            {{ form.ad }}
            {% if form.ad.errors %}
                <div class="alert alert-danger">{{ form.ad.errors }}</div>
            {% endif %}
        </div>
        <div class="mb-3">
            <label for="{{ form.detay.id_for_label }}" class="form-label">Detay</label>
            {{ form.detay }}
            {% if form.detay.errors %}
                <div class="alert alert-danger">{{ form.detay.errors }}</div>
            {% endif %}
        </div>
        <div class="mb-3">
            <label for="{{ form.kategori.id_for_label }}" class="form-label">Kategori</label>
            {{ form.kategori }}
            {% if form.kategori.errors %}
                <div class="alert alert-danger">{{ form.kategori.errors }}</div>
            {% endif %}
        </div>
        <div class="mb-3">
            <label for="{{ form.bolge.id_for_label }}" class="form-label">Kürdistan Bölgesi</label>
            {{ form.bolge }}
            {% if form.bolge.errors %}
                <div class="alert alert-danger">{{ form.bolge.errors }}</div>
            {% endif %}
        </div>
        <div class="mb-3" id="parent-field">
            <label for="{{ form.parent.id_for_label }}" class="form-label">Bağlı Olduğu Yer</label>
            {{ form.parent }}
            {% if form.parent.errors %}
                <div class="alert alert-danger">{{ form.parent.errors }}</div>
            {% endif %}
        </div>
        <div class="mb-3">
            <label for="{{ form.enlem.id_for_label }}" class="form-label">Enlem</label>
            {{ form.enlem }}
            {% if form.enlem.errors %}
                <div class="alert alert-danger">{{ form.enlem.errors }}</div>
            {% endif %}
        </div>
        <div class="mb-3">
            <label for="{{ form.boylam.id_for_label }}" class="form-label">Boylam</label>
            {{ form.boylam }}
            {% if form.boylam.errors %}
                <div class="alert alert-danger">{{ form.boylam.errors }}</div>
            {% endif %}
        </div>
        {% if duplicate_warning %}
            <div class="alert alert-warning">
                Bu yer adı zaten mevcut. Eklemeye devam etmek istiyor musunuz?
                <button type="button" class="btn btn-primary btn-sm" onclick="document.getElementById('confirm-duplicate').value='true'; document.getElementById('yer-adi-form').submit();">Evet</button>
                <a href="{% url 'yer_adlari_anasayfa' %}" class="btn btn-secondary btn-sm">Hayır</a>
                <input type="hidden" name="confirm_duplicate" id="confirm-duplicate" value="false">
            </div>
        {% endif %}
        <button type="submit" class="btn btn-primary">{% if is_edit %}Kaydet{% else %}Ekle{% endif %}</button>
    </form>
</div>

<!-- Yer Adları Verisi -->
<script id="yer-adlari-data" type="application/json">
    [
        {% for yer in form.fields.parent.queryset %}
            {
                "id": {{ yer.id }},
                "ad": "{{ yer.ad|escapejs }}",
                "kategori": "{{ yer.kategori|escapejs }}",
                "parent_id": {% if yer.parent %}{{ yer.parent.id }}{% else %}null{% endif %}
            }{% if not forloop.last %},{% endif %}
        {% endfor %}
    ]
</script>
{% endblock %}

{% block extra_scripts %}
<script src="{% static 'main/js/modules/yer_adlari/yer-adi-ekle.js' %}" defer></script>
<script src="https://maps.googleapis.com/maps/api/js?key={{ settings.GOOGLE_MAPS_API_KEY }}&callback=initMap" defer></script>
<script src="{% static 'main/js/modules/yer_adlari/map.js' %}" defer></script>
{% endblock %}