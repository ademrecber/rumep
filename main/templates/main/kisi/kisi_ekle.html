{% extends 'main/base.html' %}
{% load static %}
{% block title %}Kişi Ekle - Rumep{% endblock %}

{% block extra_css %}
<style>
    /* Select2 customization */
    .select2-container--default .select2-selection--multiple {
        border: 1px solid #ced4da;
        border-radius: 0.25rem;
        min-height: 38px;
    }
    .select2-container--default.select2-container--focus .select2-selection--multiple {
        border-color: #86b7fe;
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
    }
    .select2-container--default .select2-selection--multiple .select2-selection__choice {
        background-color: #0d6efd;
        border: none;
        color: white;
        border-radius: 0.25rem;
        padding: 2px 8px;
        margin: 3px;
    }
    .select2-container--default .select2-selection--multiple .select2-selection__choice__remove {
        color: white;
        margin-right: 5px;
    }
    .select2-container--default .select2-selection--multiple .select2-selection__choice__remove:hover {
        color: #f8f9fa;
    }
    /* Form styling */
    .form-group {
        margin-bottom: 1rem;
    }
    .form-control {
        margin-bottom: 1rem;
    }
    .quill-editor {
        margin-bottom: 1rem;
        min-height: 200px;
    }
</style>
{% endblock %}

{% block content %}
    <div class="container twitter-container">
        <h3>Kişi Ekle</h3>
        <div class="card mb-3">
            <div class="card-body">
                <form id="kisi-form" method="post" action="{% url 'kisi_ekle' %}">
                    {% csrf_token %}
                    <div class="form-group">
                        {{ form.ad.label_tag }}
                        {{ form.ad }}
                    </div>
                    <div class="form-group">
                        {{ form.kategoriler.label_tag }}
                        {{ form.kategoriler }}
                    </div>
                    <div class="form-group">
                        <label for="biyografi-editor">Biyografi</label>
                        <div id="biyografi-editor" class="quill-editor"></div>
                        <input type="hidden" name="biyografi" id="biyografi-hidden" required>
                    </div>
                    <div id="form-errors" class="alert alert-danger d-none" role="alert"></div>
                    <button type="submit" class="btn btn-primary rounded-pill mt-3">Kişi Ekle</button>
                </form>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_scripts %}
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/quill@1.3.7/dist/quill.snow.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/quill@1.3.7/dist/quill.min.js"></script>
    <script>
        $(document).ready(function() {
            // Initialize Select2 for categories
            $('.select2').select2({
                placeholder: 'Kategori seçin',
                allowClear: true,
                width: '100%',
                theme: 'bootstrap-5'
            });

            // Initialize Quill editor
            var quill = new Quill('#biyografi-editor', {
                theme: 'snow',
                placeholder: 'Biyografi yazın...',
                modules: {
                    toolbar: [
                        ['bold', 'italic', 'underline'],
                        [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                        ['link']
                    ]
                }
            });

            // Handle form submission
            $('#kisi-form').on('submit', function(e) {
                e.preventDefault();
                
                // Get Quill editor content and set it to hidden input
                var biyografiContent = quill.root.innerHTML;
                $('#biyografi-hidden').val(biyografiContent);

                // Submit form via AJAX
                $.ajax({
                    url: $(this).attr('action'),
                    type: 'POST',
                    data: $(this).serialize(),
                    success: function(response) {
                        if (response.success) {
                            window.location.href = "{% url 'kisi_liste' %}";
                        } else {
                            var errorHtml = '';
                            for (var field in response.errors) {
                                errorHtml += `<div>${response.errors[field]}</div>`;
                            }
                            $('#form-errors').html(errorHtml).removeClass('d-none');
                        }
                    },
                    error: function() {
                        $('#form-errors').html('Bir hata oluştu. Lütfen tekrar deneyin.').removeClass('d-none');
                    }
                });
            });
        });
    </script>
{% endblock %}