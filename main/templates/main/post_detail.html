{% extends 'main/base.html' %}
{% load static %}
{% load post_tags %}
{% block title %}{{ post.title|default:'' }}{% endblock %}
{% block content %}
    <meta name="critique-url" content="{% url 'list_critiques' %}?post_id={{ post.id }}">
    <div class="container twitter-container">
        <div class="card mb-3 tweet-card fade-in">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start">
                    <p class="mb-1">
                        <strong>{{ post.user.profile.nickname }}</strong> 
                        <span class="text-muted"><a href="{% url 'profile_detail' post.user.profile.username %}" class="text-muted text-decoration-none">@{{ post.user.profile.username }}</a> · {{ post.short_id}} · {{ post.created_at|timesince }}</span>
                    </p>
                    <div class="dropdown">
                        <button class="btn btn-link text-muted p-0" type="button" data-bs-toggle="dropdown">
                            <i class="bi bi-three-dots"></i>
                        </button>
                        <ul class="dropdown-menu">
                            {% if post.user == user %}
                                <li>
                                    <form method="post" action="{% url 'delete_post' post.id %}" class="m-0" onsubmit="return confirm('Ma hûn ji vê postê jêbirinê piştrast in?');">
                                        {% csrf_token %}
                                        <button type="submit" class="dropdown-item text-danger">Jêbirin</button>
                                    </form>
                                </li>
                            {% endif %}
                            <li>
                                <form method="post" action="{% url 'bookmark_post' post.id %}?tab=posts" class="bookmark-form m-0" onsubmit="return confirm('{% if bookmarked %}Ji nîşankirina cîhê derxistin{% else %}Têxistina nîşankirina cîhê{% endif %} hûn piştrast in?');" data-post-id="{{ post.id }}">
                                    {% csrf_token %}
                                    <button type="submit" class="dropdown-item">
                                        {% if bookmarked %}Ji Nîşankirina Cîhê Derxistin{% else %}Têxistina Nîşankirina Cîhê{% endif %}
                                    </button>
                                </form>
                            </li>
                            <li>
                                <button class="dropdown-item copy-link-btn" data-post-id="{{ post.id }}">Girêdanê Kopî Bike</button>
                            </li>
                        </ul>
                    </div>
                </div>
                <h5>{{ post.title|default:'Bêsernav' }}</h5>
                <div class="post-text">
                    <p>{{ post.text|render_emojis|safe|linebreaks }}</p>
                </div>
                {% if post.link %}
                    <a href="{{ post.link }}" target="_blank" class="text-muted mt-2 d-block">{{ post.link }}</a>
                {% endif %}
                {% if post.embed_code %}
                    <div class="social-embed">{{ post.embed_code|safe }}</div>
                {% endif %}
                <div class="post-meta text-muted mt-2">
                    <span>Ecibandin: {{ like_count }}</span> | 
                    <span>Şîrove: {{ comment_count }}</span> | 
                    <span><i class="bi bi-bar-chart"></i> {{ post.views }}</span>
                </div>
                <div class="post-actions mt-2">
                    <form method="post" action="{% url 'like_post' post.id %}" class="like-form d-inline">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-link like-btn {% if request.user in post.likes.all %}liked{% endif %}" data-post-id="{{ post.id }}">
                            <i class="bi {% if request.user in post.likes.all %}bi-heart-fill{% else %}bi-heart{% endif %}"></i> {{ like_count }}
                        </button>
                    </form>
                    <form method="post" action="{% url 'vote_post' post.id %}" class="vote-form d-inline" data-post-id="{{ post.id }}">
                        {% csrf_token %}
                        <input type="hidden" name="vote" value="up">
                        <button type="submit" class="btn btn-link text-success p-0 upvote-btn" data-vote-type="up">{{ post.upvotes }} ↑</button>
                    </form>
                    <form method="post" action="{% url 'vote_post' post.id %}" class="vote-form d-inline" data-post-id="{{ post.id }}">
                        {% csrf_token %}
                        <input type="hidden" name="vote" value="down">
                        <button type="submit" class="btn btn-link text-danger p-0 downvote-btn" data-vote-type="down">{{ post.downvotes }} ↓</button>
                    </form>
                </div>
                <!-- Web için eleştiri butonu -->
                <div class="d-none d-md-block mt-3">
                    <button class="btn btn-primary rounded-pill toggle-critique-btn">
                        <i class="bi bi-star me-1"></i>Vê nivîsê nirxandin bike
                    </button>
                </div>
            </div>
        </div>

        <!-- Mobil için eleştiri butonu ve liste -->
        <div class="card mb-3 d-md-none mobile-critique-section">
            <div class="card-body p-3">
                <div class="d-flex flex-column gap-2">
                    <button class="btn btn-primary rounded-pill btn-sm toggle-critique-btn">
                        <i class="bi bi-star me-1"></i>Vê nivîsê nirxandin bike
                    </button>
                    <button class="btn btn-outline-primary btn-sm rounded-pill" type="button" data-bs-toggle="collapse" data-bs-target="#mobile-critique-list" aria-expanded="false" aria-controls="mobile-critique-list">
                        <i class="bi bi-list-ul me-1"></i>Nirxandinên Dawî 
                        <i class="bi bi-chevron-down ms-1 collapse-icon"></i>
                    </button>
                </div>
                <div class="collapse mt-3" id="mobile-critique-list">
                    <div class="mobile-critique-container" style="max-height: 250px; overflow-y: auto; border-radius: 8px; background-color: #f8f9fa; padding: 10px;">
                        <!-- Dinamik olarak critique_loader.js tarafından dolduruluyor -->
                    </div>
                </div>
            </div>
        </div>

        <div class="card mb-3 slide-up critique-form-card" id="critique-section" style="display: none;">
            <div class="card-body p-3">
                <div class="d-flex align-items-center mb-3">
                    <i class="bi bi-star-fill text-warning me-2"></i>
                    <h6 class="mb-0">Nirxandina Xwe Binivîse</h6>
                </div>
                <form method="post" id="critique-form" data-action="{% url 'add_critique' post.id %}">
                    {% csrf_token %}
                    <input type="hidden" name="critique_submit" value="1">
                    <div class="critique-input-container">
                        <textarea name="text" class="form-control auto-grow critique-textarea" placeholder="Nirxandina xwe binivîse..." maxlength="5000" required rows="3"></textarea>
                        <div class="d-flex justify-content-between align-items-center mt-2">
                            <button type="button" class="btn btn-link text-muted p-1" id="emojiButton" data-bs-toggle="modal" data-bs-target="#emojiModal" title="Emoji ekle">
                                <i class="bi bi-emoji-smile" style="font-size: 1.2rem;"></i>
                            </button>
                            <small class="text-muted char-count">0/5000</small>
                        </div>
                    </div>
                    <div class="d-flex gap-2 mt-3">
                        <button type="submit" class="btn btn-primary rounded-pill flex-fill">
                            <i class="bi bi-send me-1"></i>Şandin
                        </button>
                        <button type="button" class="btn btn-outline-secondary rounded-pill" id="cancel-critique-btn">
                            <i class="bi bi-x-lg"></i>
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Emoji Picker Modal -->
        <div class="modal fade" id="emojiModal" tabindex="-1" aria-labelledby="emojiModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="emojiModalLabel">Emojî Hilbijêre</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div id="emojiKeyboard" class="d-flex flex-wrap"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Eleştiri Modal -->
        <div class="modal fade" id="critiqueModal" tabindex="-1" aria-labelledby="critiqueModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="critiqueModalLabel">Kîtekîtên Nirxandinê</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <p>
                            <strong id="modal-nickname"></strong> 
                            <span class="text-muted" id="modal-username"></span>
                            <span class="text-muted" id="modal-short-id"></span>
                        </p>
                        <p class="text-muted small" id="modal-date"></p>
                        <p id="modal-text"></p>
                        <p id="modal-rating" class="text-muted small">Pûana Navîn: <span id="modal-rating-value"></span></p>
                        <p id="modal-user-rating" class="text-muted small">Pûana We: <span id="modal-user-rating-value"></span></p>
                        <div id="rating-buttons" class="mt-2"></div>
                        <form id="delete-critique-form" method="post" style="display: none;">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-danger btn-sm mt-2">Nirxandinê Jêbibe</button>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary rounded-pill" data-bs-dismiss="modal">Girtin</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Puanlama Modalı -->
        <div class="modal fade" id="voteCritiqueModal" tabindex="-1" aria-labelledby="voteCritiqueModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header border-0 pb-0">
                        <h5 class="modal-title" id="voteCritiqueModalLabel">
                            <i class="bi bi-star-fill text-warning me-2"></i>Pûan Bide
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body text-center">
                        <p class="mb-4">Ji bo vê nirxandinê hûn ê çend pûan bidin?</p>
                        <div id="star-rating" class="d-flex justify-content-center flex-wrap gap-1 mb-3">
                            {% for i in "12345678910" %}
                                <i class="bi bi-star-fill text-muted star-rating-item" data-value="{{ i }}" style="cursor: pointer; font-size: 1.8rem; transition: all 0.2s ease;"></i>
                            {% endfor %}
                        </div>
                        <div class="rating-text text-muted small" id="rating-text">Pûan hilbijêre</div>
                    </div>
                    <div class="modal-footer border-0 pt-0">
                        <button type="button" class="btn btn-primary rounded-pill flex-fill" id="submit-vote-critique" disabled>
                            <i class="bi bi-check-lg me-1"></i>Şandin
                        </button>
                        <button type="button" class="btn btn-outline-secondary rounded-pill" data-bs-dismiss="modal">
                            <i class="bi bi-x-lg me-1"></i>Betal
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Yorum Formu -->
        <div class="card mb-3 fade-in comment-form-card">
            <div class="card-body p-3">
                <div class="d-flex align-items-center mb-3">
                    <i class="bi bi-chat-dots me-2 text-primary"></i>
                    <h6 class="mb-0">Şîroveya Xwe Binivîse</h6>
                </div>
                <form method="post" id="commentForm" action="{% url 'post_detail' post.id %}">
                    {% csrf_token %}
                    <input type="hidden" name="comment_submit" value="1">
                    <div class="comment-input-container">
                        <textarea name="text" class="form-control auto-grow comment-textarea" placeholder="Şîroveya xwe binivîse..." maxlength="5000" required rows="3"></textarea>
                        <div class="d-flex justify-content-between align-items-center mt-2">
                            <button type="button" class="btn btn-link text-muted p-1" id="emojiButton" data-bs-toggle="modal" data-bs-target="#emojiModal" title="Emoji ekle">
                                <i class="bi bi-emoji-smile" style="font-size: 1.2rem;"></i>
                            </button>
                            <small class="text-muted char-count">0/5000</small>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary rounded-pill mt-2 w-100">
                        <i class="bi bi-send me-1"></i>Şîrove Bike
                    </button>
                </form>
            </div>
        </div>

        <div class="comments-section">
            {% include 'main/comment_tree.html' with comment_tree=comment_tree %}
        </div>

        <!-- Toast Mesajı -->
        <div class="toast-container position-fixed bottom-0 end-0 p-3">
            <div id="copyToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="toast-header">
                    <strong class="me-auto">Agahî</strong>
                    <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
                <div class="toast-body">
                    Girêdan hate kopîkirin!
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_scripts %}
    <script type="module" src="{% static 'main/js/copy-link.js' %}"></script>
    <script type="module">
        document.addEventListener('DOMContentLoaded', () => {
            // Auto-grow textareas
            const textareas = document.querySelectorAll('textarea.auto-grow');
            textareas.forEach(textarea => {
                textarea.addEventListener('input', function() {
                    this.style.height = 'auto';
                    this.style.height = `${this.scrollHeight}px`;
                    
                    // Update character count
                    const charCount = this.closest('.card-body').querySelector('.char-count');
                    if (charCount) {
                        const current = this.value.length;
                        const max = this.maxLength;
                        charCount.textContent = `${current}/${max}`;
                        
                        // Change color based on usage
                        if (current > max * 0.9) {
                            charCount.classList.add('text-danger');
                            charCount.classList.remove('text-warning', 'text-muted');
                        } else if (current > max * 0.7) {
                            charCount.classList.add('text-warning');
                            charCount.classList.remove('text-danger', 'text-muted');
                        } else {
                            charCount.classList.add('text-muted');
                            charCount.classList.remove('text-danger', 'text-warning');
                        }
                    }
                });
            });
            
            // Critique toggle for both mobile and desktop
            const toggleCritiqueBtns = document.querySelectorAll('.toggle-critique-btn');
            const critiqueSection = document.getElementById('critique-section');
            const cancelBtn = document.getElementById('cancel-critique-btn');
            
            if (toggleCritiqueBtns.length > 0 && critiqueSection) {
                toggleCritiqueBtns.forEach(btn => {
                    btn.addEventListener('click', () => {
                        critiqueSection.style.display = 'block';
                        critiqueSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        
                        // Focus on textarea after animation
                        setTimeout(() => {
                            const textarea = critiqueSection.querySelector('textarea');
                            if (textarea) textarea.focus();
                        }, 300);
                    });
                });
            }
            
            if (cancelBtn && critiqueSection) {
                cancelBtn.addEventListener('click', () => {
                    critiqueSection.style.display = 'none';
                    const textarea = critiqueSection.querySelector('textarea');
                    if (textarea) {
                        textarea.value = '';
                        textarea.style.height = 'auto';
                    }
                });
            }
            
            // Enhanced star rating for voting modal
            const stars = document.querySelectorAll('.star-rating-item');
            const submitVoteBtn = document.getElementById('submit-vote-critique');
            const ratingText = document.getElementById('rating-text');
            let selectedRating = 0;
            
            const ratingTexts = {
                1: '1 - Pir xerab',
                2: '2 - Xerab', 
                3: '3 - Ne baş ne xerab',
                4: '4 - Baş',
                5: '5 - Pir baş',
                6: '6 - Hêja',
                7: '7 - Pir hêja',
                8: '8 - Navdar',
                9: '9 - Pir navdar', 
                10: '10 - Bêhempa!'
            };
            
            function updateStars(rating) {
                stars.forEach(s => {
                    if (parseInt(s.dataset.value) <= rating) {
                        s.classList.add('text-warning');
                        s.classList.remove('text-muted');
                    } else {
                        s.classList.add('text-muted');
                        s.classList.remove('text-warning');
                    }
                });
            }
            
            stars.forEach(star => {
                star.addEventListener('mouseover', () => {
                    const value = parseInt(star.dataset.value);
                    updateStars(value);
                    if (ratingText) ratingText.textContent = ratingTexts[value];
                });
                
                star.addEventListener('mouseout', () => {
                    updateStars(selectedRating);
                    if (ratingText) {
                        ratingText.textContent = selectedRating > 0 ? ratingTexts[selectedRating] : 'Pûan hilbijêre';
                    }
                });
                
                star.addEventListener('click', () => {
                    selectedRating = parseInt(star.dataset.value);
                    if (submitVoteBtn) submitVoteBtn.disabled = false;
                    updateStars(selectedRating);
                    if (ratingText) ratingText.textContent = ratingTexts[selectedRating];
                    
                    // Add click animation
                    star.style.transform = 'scale(1.3)';
                    setTimeout(() => {
                        star.style.transform = '';
                    }, 150);
                });
            });
            
            // Reset stars when modal is closed
            const voteModal = document.getElementById('voteCritiqueModal');
            if (voteModal) {
                voteModal.addEventListener('hidden.bs.modal', () => {
                    selectedRating = 0;
                    if (submitVoteBtn) submitVoteBtn.disabled = true;
                    updateStars(0);
                    if (ratingText) ratingText.textContent = 'Pûan hilbijêre';
                });
            }
        });
    </script>
{% endblock %}